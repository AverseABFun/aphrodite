#!/bin/bash

DIR="${BASH_SOURCE%/*}"
if [[ ! -d "$DIR" ]]; then DIR="$PWD"; fi

. "$DIR/functions"

get_version

cd ../kernel

cargo build --target i686-unknown-none.json --release -Zbuild-std --bin entrypoint
# build the kernel's entrypoint

cp target/i686-unknown-none/release/entrypoint kernel.flat
# copy it out

rm -rf grub

cp -r ./grub_template ./grub

cp kernel.flat ./grub/boot/aphrodite.kernel

sed -i "s@%{VERSION}@$VERSION@g" ./grub/boot/grub/grub.cfg

grub-mkrescue -o aphrodite-grub.iso grub
cp aphrodite-grub.iso aphrodite.iso